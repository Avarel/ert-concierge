!function(e){var t={};function s(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(n,o,function(t){return e[t]}.bind(null,o));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=2)}([function(e,t){e.exports=BABYLON},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServiceEventHandler=t.EventHandler=t.Client=void 0;t.Client=class{constructor(e,t,s=!1){this.seq=0,this.reconnectInterval=1e4,this.handlers=[],this.url=t,this.name=e,this.reconnect=s}connect(e,t){console.info("Trying to connect to ",this.url),this.version=e,this.secret=t,this.socket=new WebSocket(this.url),this.socket.onopen=e=>this.onOpen(e),this.socket.onmessage=e=>this.onReceive(e),this.socket.onerror=e=>this.onError(e),this.socket.onclose=e=>this.onClose(e)}sendJSON(e){if(null==this.socket)throw new Error("Socket is not connected");this.socket.send(JSON.stringify(e));let t=this.seq;return this.seq+=1,t}close(e,t,s=!0){if(null==this.socket)throw new Error("Socket is not connected");this.socket.close(e,t),s?this.tryReconnect():(this.socket=void 0,this.version=void 0,this.secret=void 0)}tryReconnect(){this.reconnect&&(console.warn("Connection closed, reconnecting in",this.reconnectInterval,"ms"),setTimeout(()=>{this.connect(this.version,this.secret)},this.reconnectInterval))}onOpen(e){var t;for(let s of this.handlers)null===(t=s.onOpen)||void 0===t||t.call(s,e);if(null==this.version)throw new Error("Version is undefined");console.log("Identifying with version",this.version),this.sendJSON({type:"IDENTIFY",name:this.name,version:this.version,secret:this.secret})}onClose(e){var t;for(let s of this.handlers)null===(t=s.onClose)||void 0===t||t.call(s,e);console.warn(e.code,e.reason),this.tryReconnect()}onReceive(e){var t;let s=JSON.parse(e.data);if(s.hasOwnProperty("type")){let e=s;"HELLO"==e.type&&(this.uuid=e.uuid);for(let s of this.handlers)null===(t=s.onReceive)||void 0===t||t.call(s,e)}}onError(e){var t;for(let s of this.handlers)null===(t=s.onError)||void 0===t||t.call(s,e);console.log(e)}};class n{onReceive(e){var t,s,n,o,r,i,a;switch(e.type){case"MESSAGE":null===(t=this.onRecvMessage)||void 0===t||t.call(this,e);break;case"HELLO":null===(s=this.onRecvHello)||void 0===s||s.call(this,e);break;case"GROUP_SUBSCRIBERS":null===(n=this.onRecvGroupSubs)||void 0===n||n.call(this,e);break;case"GROUPS":null===(o=this.onRecvGroupList)||void 0===o||o.call(this,e);break;case"CLIENTS":null===(r=this.onRecvClientList)||void 0===r||r.call(this,e);break;case"SUBSCRIPTIONS":null===(i=this.onRecvSubscriptions)||void 0===i||i.call(this,e);break;case"STATUS":null===(a=this.onRecvStatus)||void 0===a||a.call(this,e)}}}t.EventHandler=n;t.ServiceEventHandler=class extends n{constructor(e,t){super(),this.client=e,this.group=t}onClose(e){this.onUnsubscribe()}onRecvHello(e){this.client.sendJSON({type:"FETCH_GROUPS"})}onRecvGroupList(e){e.groups.includes(this.group)&&this.subscribe(this.group)}subscribe(e){this.client.sendJSON({type:"SUBSCRIBE",group:e})}onRecvStatus(e){switch(e.code){case"NO_SUCH_GROUP":e.group==this.group&&console.error("Group `",this.group,"` does not exist on concierge.");break;case"GROUP_DELETED":e.group==this.group&&console.warn("Group `",this.group,"` has been deleted on the concierge.");break;case"GROUP_CREATED":e.group==this.group&&this.subscribe(this.group);break;case"SUBSCRIBED":e.group==this.group&&(console.log("Subscribed to `",this.group,"`."),this.onSubscribe());break;case"UNSUBSCRIBED":e.group==this.group&&(console.log("Unsubscribed from `",this.group,"`."),this.onUnsubscribe())}}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(3),o=s(1),r=s(4),i=s(5),a=s(7);let l=document.querySelector("#renderCanvas");if(!l)throw"Canvas is not found!";l.focus();var c=prompt("Please enter the server address","ws://127.0.0.1:64209/ws");if("debug"==c){throw new n.Renderer(l).start(),"Debug mode"}if(!c||0==c.length)throw alert("A server address is required, please restart the webpage.");var h=prompt("Please enter your name","anthony");if(!h||0==h.length)throw alert("A valid name, please restart the webpage.");let u=new n.Renderer(l),d=new o.Client(h,c,!0),p=new r.PhysicsHandler(d,u);d.handlers.push(p);let g=new i.ChatHandler(d,u);d.handlers.push(g);let S=new a.PlanetsHandler(d,u);d.handlers.push(S),u.start(),d.connect("0.1.0")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Renderer=void 0;const n=s(0),o=s(0);t.Renderer=class{constructor(e){this.canvas=e,this.engine=new n.Engine(e,!0)}createScene(){this.scene&&this.scene.dispose();let e=new n.Scene(this.engine),t=new n.UniversalCamera("UniversalCamera",new o.Vector3(500,800,-100),e);t.setTarget(new o.Vector3(500,0,500)),t.speed=15,t.attachControl(this.canvas,!0),t.keysDownward.push(17),t.keysUpward.push(32),t.keysUp.push(87),t.keysDown.push(83),t.keysLeft.push(65),t.keysRight.push(68);let s=new n.PointLight("light1",new n.Vector3(500,500,500),e);s.intensity=1;let r=e.createDefaultEnvironment({skyboxSize:1050,groundSize:1050,groundShadowLevel:.5,enableGroundShadow:!0});r.ground.position.set(500,0,500),r.skybox.position.set(500,0,500),r.skybox.isPickable=!1,r.setMainColor(n.Color3.FromHexString("#74b9ff")),this.generator=new n.ShadowGenerator(512,s),e.createDefaultVRExperience({createDeviceOrientationCamera:!1}).enableTeleportation({floorMeshes:[r.ground]}),this.scene=e}start(){null==this.scene&&this.createScene();let e=()=>{this.scene?this.scene.render():this.engine.stopRenderLoop(e)};this.engine.runRenderLoop(e),window.addEventListener("resize",()=>{this.engine.resize()})}stop(){this.engine.stopRenderLoop()}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PhysicsHandler=t.PHYSICS_ENGINE_GROUP=t.PHYSICS_ENGINE_NAME=void 0;const n=s(1),o=s(0);function r(e){return new o.Vector2(e.x,e.y)}function i(e){function t(e){return Math.max(0,Math.min(e,255))/255}return new o.Color3(t(e[0]),t(e[1]),t(e[2]))}t.PHYSICS_ENGINE_NAME="physics_engine",t.PHYSICS_ENGINE_GROUP="physics_engine_out";class a{constructor(e,t){this.centroid=e,this.mesh=t}static createPolygon(e,t,s,n,r=1){let i=t.map(e=>e.scale(r)),l=new o.PolygonMeshBuilder("polytri",i,s).build(void 0,50);l.position.y+=50;var c=new o.StandardMaterial("myMaterial",s);return c.diffuseColor=n,l.material=c,l.actionManager=new o.ActionManager(s),new a(e,l)}setColor(e){this.mesh.material.diffuseColor=e}moveTo(e){let t=e.subtract(this.centroid);this.mesh.position.addInPlace(t),this.centroid.set(e.x,e.y,e.z)}}class l extends n.ServiceEventHandler{constructor(e,s){super(e,t.PHYSICS_ENGINE_GROUP),this.client=e,this.renderer=s,this.shapes=new Map}onRecvMessage(e){e.origin.name==t.PHYSICS_ENGINE_NAME&&this.processPhysicsPayload(e.data)}onSubscribe(){console.log("Fetching..."),this.client.sendJSON({type:"MESSAGE",target:{type:"NAME",name:t.PHYSICS_ENGINE_NAME},data:{type:"FETCH_ENTITIES"}})}onUnsubscribe(){this.clearShapes()}clearShapes(){var e;for(let t of this.shapes.keys())if(this.shapes.has(t)){let s=this.shapes.get(t);null===(e=this.renderer.generator)||void 0===e||e.removeShadowCaster(s.mesh),s.mesh.dispose(),this.shapes.delete(t)}}createPolygon(e,t,s,n,r=1){var i;if(this.renderer.scene){let l=a.createPolygon(new o.Vector3(t.x,0,t.y),s,this.renderer.scene,n,r);return this.shapes.set(e,l),null===(i=this.renderer.generator)||void 0===i||i.addShadowCaster(l.mesh),l}throw new Error("Scene not initialized!")}createShape(e,s,n,a,l=1){let c=r(s),h=n.map(r),u=i(a);this.createPolygon(e,c,h,u,l).mesh.actionManager.registerAction(new o.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger,()=>{console.log("Clicking on object ",e,"."),this.client.sendJSON({type:"MESSAGE",target:{type:"NAME",name:t.PHYSICS_ENGINE_NAME},data:{type:"TOGGLE_COLOR",id:e}})}))}updateShape(e,t){let s=this.shapes.get(e);s&&s.moveTo(new o.Vector3(t.x,0,t.y))}updateColor(e,t){let s=this.shapes.get(e);s&&s.setColor(i(t))}processPhysicsPayload(e){switch(e.type){case"ENTITY_DUMP":console.log("Dumping entities!"),this.clearShapes();for(let t of e.entities)this.createShape(t.id,t.centroid,t.points,t.color);break;case"POSITION_DUMP":for(let t of e.updates)this.updateShape(t.id,t.position);break;case"COLOR_UPDATE":this.updateColor(e.id,e.color)}}}t.PhysicsHandler=l},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatHandler=void 0;const n=s(6),o=s(1);class r extends o.ServiceEventHandler{constructor(e,t){super(e,"chat"),this.renderer=t,this.client=e}createUITexture(){this.uiTexture&&this.uiTexture.dispose();let e=n.AdvancedDynamicTexture.CreateFullscreenUI("UI");this.uiTexture=e}onSubscribe(){this.createUITexture();let e=new n.StackPanel;e.verticalAlignment=n.Control.VERTICAL_ALIGNMENT_BOTTOM,e.fontFamily="monospace";let t=new n.ScrollViewer;t.horizontalAlignment=n.Control.HORIZONTAL_ALIGNMENT_LEFT,t.verticalAlignment=n.Control.VERTICAL_ALIGNMENT_BOTTOM,t.heightInPixels=150,t.width=.4,t.thickness=0,t.background="#080808",t.thumbLength=.2,t.barSize=10;let s=new n.TextBlock;s.fontFamily="monospace",s.textHorizontalAlignment=n.Control.HORIZONTAL_ALIGNMENT_LEFT,s.resizeToFit=!0,s.color="white",s.textWrapping=n.TextWrapping.WordWrap,s.fontSizeInPixels=14,this.output=s,t.addControl(s),e.addControl(t);let o=new n.InputText;o.horizontalAlignment=n.Control.HORIZONTAL_ALIGNMENT_LEFT,o.fontFamily="monospace",o.width=.4,o.maxWidth=.4,o.heightInPixels=40,o.fontSizeInPixels=14,o.color="white",o.text="Click to chat.",o.thickness=0,o.background="black",o.onPointerClickObservable.add(e=>{"Click to chat."==o.text&&(o.text="")}),o.onKeyboardEventProcessedObservable.add(e=>{"Enter"==e.code&&this.onEnter()}),this.input=o,e.addControl(this.input),this.uiTexture.addControl(e)}onEnter(){null!=this.input?(this.client.sendJSON({type:"MESSAGE",target:{type:"GROUP",group:"chat"},data:this.input.text}),this.input.text="Click to chat."):console.warn("Chat input UI has not been created")}onRecvMessage(e){"chat"==e.origin.group&&(null!=this.output?(0!=this.output.text.length&&(this.output.text+="\n"),this.output.text+=`${e.origin.name}: ${e.data}`):console.warn("Chat output UI has not been created"))}onUnsubscribe(){var e,t,s;null===(e=this.input)||void 0===e||e.dispose(),null===(t=this.output)||void 0===t||t.dispose(),null===(s=this.uiTexture)||void 0===s||s.dispose()}}t.ChatHandler=r},function(e,t){e.exports=BABYLON.GUI},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlanetsHandler=t.PLANET_SIM_GROUP=t.PLANET_SIM_NAME=void 0;const n=s(1),o=s(0);t.PLANET_SIM_NAME="planetary_simulation",t.PLANET_SIM_GROUP="planetary_simulation_out";class r{constructor(e,t){this.centroid=e,this.mesh=t}static createSphere(e,t,s,n,i=1){let a=o.MeshBuilder.CreateSphere("mySphere",{diameter:2*t*i},s);a.position=e;var l=new o.StandardMaterial("myMaterial",s);return l.diffuseColor=n,a.material=l,a.actionManager=new o.ActionManager(s),new r(e,a)}setColor(e){this.mesh.material.diffuseColor=e}moveTo(e){let t=e.subtract(this.centroid);this.mesh.position.addInPlace(t),this.centroid.set(e.x,e.y,e.z)}}class i extends n.ServiceEventHandler{constructor(e,s){super(e,t.PLANET_SIM_GROUP),this.client=e,this.renderer=s,this.planets=new Map}onRecvMessage(e){e.origin.name==t.PLANET_SIM_NAME&&this.processPhysicsPayload(e.data)}onSubscribe(){}onUnsubscribe(){this.clearShapes()}clearShapes(){var e;for(let t of this.planets.keys())if(this.planets.has(t)){let s=this.planets.get(t);null===(e=this.renderer.generator)||void 0===e||e.removeShadowCaster(s.mesh),s.mesh.dispose(),this.planets.delete(t)}}processPhysicsPayload(e){var t;this.sysData=e.systemData;for(let s of e.objects){let e=new o.Vector3(s.locationX,s.locationY,s.locationZ).scaleInPlace(1/this.sysData.scale).scaleInPlace(500);if(this.planets.has(s.name))this.planets.get(s.name).moveTo(e);else{if(!this.renderer.scene)throw new Error("Scene not initialized!");{let n=s.radius/this.sysData.scale*this.sysData.bodyScale*500,i=o.Color3.Black();s.name==this.sysData.centralBodyName&&(console.log("Found central body!"),n*=this.sysData.centralBodyScale,e.scaleInPlace(this.sysData.centralBodyScale),i=o.Color3.Yellow()),console.log(`Creating object (radius = ${n}, location = ${e.toString()})`);let a=r.createSphere(e,n,this.renderer.scene,i);this.planets.set(s.name,a),null===(t=this.renderer.generator)||void 0===t||t.addShadowCaster(a.mesh)}}}}}t.PlanetsHandler=i}]);